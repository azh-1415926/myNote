Linux C 编程环境

Linux系统下一般使用C语言编写系统程序以及对性能有较高要求的程序。Linux环境通常使用 gcc 套件编译程序，运用gdb/ddd 调试工具进行程序的调试和排错。Windows 系统的开发环境(如 Visual Studio 2018)-般可将这两种功能集成在-起使用，Linux虽然也有-一些这样的集成开发环境，如Eclipse，但很多熟练的程序员喜欢直接用gcc命令行工具进行开发，这样编程效率更高。本章介绍用Linux环境中的gcc开发套件对程序进行编译、调试、排错和项目管理的基本方法，是Linux 环境下使用C/C++进行系统编程和应用编程开发的基础，其中涉及的方法和原理也适用于Windows 等非Linux环境

Linux C 程序的编译与执行

首先创建一个 hello.c，运行 gcc hello.c，再用 ls -l 列出当前目录下的文件，会发现生成了一个 a.out 程序，这就是执行 gcc 命令后产生的可执行文件，./a.out 可以执行该程序，gcc 是 Linux 环境下的 C 语言编译器，gcc 命令的用法 gcc 选项 文件名称，gcc 命令选项多达 100 个，gcc 将源程序转换成可执行文件需要经历预处理、编译、汇编以及链接四个过程

预处理

gcc 调用预处理程序 cpp，扫描源代码，检查其中的宏定义与预处理命令，执行宏替换，展开包含文件，删除程序中的注释以及多余的空白字符，带命令选项 -E 的 gcc 命令调用预处理程序 cpp 对源程序做预处理，-o 可以指定处理后的文件名称，预处理的输出文件一般为.i为后缀

编译

带命令选项 -S 的gcc 命令调用编译程序 ccl 对 .c 或 .i 源程序进行编译，产生汇编语言代码，用 -o选项指定汇编代码文件名，编译的输出文件一般为.s为后缀

汇编

命令选项 -c 的 gcc 命令调用汇编程序 as，将汇编代码汇编成目标机器指令，它生成与源程序同名的.o目标代码文件，使用 -c 选项表示让 gcc 仅完成前三步，即可实现对源代码的预编译、编译和汇编

链接

使用不带 -S、-c、-E 选项的 gcc 命令将根据需要，执行预处理、编译、汇编，并调用链接程序 collect2，将一个或多个目标代码文件与相关库文件链接起来，产生可执行文件
使用头文件和库文件
在软件开发过程中，经常会使用外部或其他模块提供的功能，这些功能一般以库文件的形式提供，比如输入输出要调用 IO 库函数,开发图形用户界面需要使用图形库，开发动画程序需要使用 OpenGL 库，从摄像头采集视频需要调用视频库。未来开发应用时，几乎都不可避免要使用某种库文件(又称函数库)，这些库文件提供的函数又称API函数。函数库是由-些提供公共功能的函数、代码、变量定义的二进制代码文件，可被各种应用程序调用，链接到它们的可执行程序中。函数库里有Linux系统自带库函数、第三方库函数和用户自定义库函数。为让调用库函数的程序能正确编译链接和执行，需要做三件事情:

(1)用 #include 包含这些库函数的原型、相关类型定义的头文件

如果不知道系统中库函数的头文件名称，可以 man 查询函数使用说明，如果需调用第三方 API 库函数，可从相关厂商取得对应头文件，即便是用户定义库函数，程序员也应创建相关头文件

(2)在 gcc 链接命令中用 -l(link) 选项指明包含 API 或库函数代码实现的库文件

库文件一般是由多个 .o 文件打包而成的文件，按照库文件加载时机的不同，有静态库及动态库(或共享库)两种形式

当用选项 -Bstatic 指明采用静态链接时，gcc 将静态库代码复制到每一个可执行文件中，随着程序启动而加载到内存中。Linux 静态库以 .a 为文件名后缀，对于名为 name 的静态库，文件名命名规范一般为 libname.a

当采用动态链接时，gcc 仅将动态库的链接信息写到可执行文件中，不复制库函数代码，生成的可执行文件比较小。动态库仅当程序运行过程中实际调用库中的函数时才加载到内存中。动态库又称共享库，仅在内存中保存-一个副本，为多个应用程序共用，节省内存用量。当动态库修正错误或更新升级时，只要调用接口不变，使用它的源程序就不需要重新编译。动态库的文件名后缀为 .so,对于名为 name 的动态库，文件命名规范一般为 libname.so

系统库函数、第三方库函数和用户自定义库函数都有相应的库文件。Linux 自带的库文件有数十个之多，一般用到哪个就加载哪个，为此需要在gcc命令中用 -l 选项指明函数库名称。比如，如果要链接库文件 libname.so 或libname.a,则gcc命令要增加选项-lname。gcc 默认使用共享库文件，如果要使用静态库，则应增加 -Bstatic 选项。由于大多数程序都要调用 scanf、printf、 fread、 fwrite 等库函数，gcc 在默认情况下自动将系统I/O库 libc.so 链接到可执行文件,因此不需要用链接选项“-lc”指明使用I/O库文件名libc.a或libc.so。因此，在前面的“gcc hello.c"命令中就没有使用-1选项。但如果调用了其他种类的库函数，如数学运算、线程管理函数,就必须用-1选项指定库文件名

(3)有时需要用_I选项和-L选项分别指定第三方库函数的头文件和库文件所在目录
-Idir选项(I是英文单词Include的首字母): gcc命令搜索h头文件的默认目录,一-般 是/usr/include.
如果被搜索的头文件位于其他目录下，则使用-I选项将该目录增加到搜索头文件的路径中。注意:
-I后面紧跟包含文件的目录路径，中间无空格。若代码行#include<wrapper.h>涉及的文件在当前目录
下，则gcc命令应有选项“I.”。由于用引号指明的头文件规定仅在当前目录下搜索，因此写成代
码行#include "wrapper.h"时就不需要“-I.” 选项。.
-Ldir选项(L是单词Link的首字母):通常gcc生成可执行文件所需的系统库文件位于默认目录
/us/lib下，如果所需的库文件位于其他目录下，则使用-L将该目录添加到库文件的搜索路径中。-L
与库文件目录间也没有空格。若所需库文件在当前目录下，则编译命令中应加入选项“L.”。

使用 gcc 创建自定义库文件

尽管很多情况下只需要调用已有的库函数,但有时也编写一些函数模块供他人使用，或作为 API 库发布给开发者，这时可以创建自己的库文件

(1) 静态库文件的创建和使用

首先使用带 -c 选项的 gcc 命令仅将其编译为目标文件，而不进行链接，生成目标文件

然后使用命令 ar 生成静态库文件 libname.a，名称必须以 lib 开头，后缀必须为 .a

`ar rc lib静态库名.a 目标文件.o 目标文件.o` 参数 r 表示将目标文件加入静态库，参数 c 表示创建新的静态库文件

`gcc 源文件 -Bstatic -L 静态库目录 -l 静态库名 -o 可执行程序名称`  -Bstatic 选项强制 gcc 使用静态库链接，因为自制库文件的目录非默认的库文件搜索路径中，因此必须用 -L 选项添加到库文件搜索路径中，选项 -l 指定库文件，-o 指定可执行程序名称

(2) 动态库文件的创建和使用

首先使用命令生成源文件的目标文件，在使用 -c 参数的 gcc的同时再加上 -fPIC 选项表示生成位置无关代码

`gcc -c -fPIC 源文件 -o 目标文件.o ...` 

再通过以下命令创建共享库

`gcc -shared -o lib动态库名.so 目标文件.o 目标文件.o ...` 

